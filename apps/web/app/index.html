<!DOCTYPE html>
<html lang="sv">

<head>
    <script>
        (function () {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            // Prevent white flash by setting background immediately
            if (savedTheme === 'dark') {
                document.documentElement.style.backgroundColor = '#050505';
            } else {
                document.documentElement.style.backgroundColor = '#f8fafc';
            }
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Veridat hj√§lper dig med bokf√∂ring, moms och f√∂retagande.">
    <meta name="theme-color" content="#00F0FF">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Veridat">
    <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">

    <title>Veridat - Bokf√∂ringsexpert</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://api.fontshare.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@400,500,700,900&display=swap" rel="stylesheet">
    <!-- SheetJS Library for Excel parsing -->
    <!-- The SheetJS script is moved to the end of body for better performance and to be grouped with other scripts. -->
    
    <!-- Vercel Web Analytics -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
</head>


<body>
    <!-- Loading Overlay -->
    <div id="app-loader"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: var(--bg-color); transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1);">
        <div class="loader-content"
            style="position: relative; display: flex; flex-direction: column; align-items: center; gap: 24px;">
            <div class="logo-container"
                style="position: relative; width: 64px; height: 64px; display: flex; align-items: center; justify-content: center;">
                <style>
                    .loader-orb {
                        width: 48px;
                        height: 48px;
                        border-radius: 50%;
                        /* Unified High-Fidelity 3D Shading (Grey) */
                        background: radial-gradient(circle at 35% 35%, 
                            #cbd5e1 0%,  /* High: Slate-300 */
                            #94a3b8 45%, /* Mid: Slate-400 */
                            #475569 100% /* Shadow: Slate-600 */
                        );
                        box-shadow: 
                            inset 2px 2px 3px rgba(255, 255, 255, 0.9),
                            inset -2px -2px 10px rgba(255, 255, 255, 0.4),
                            inset -5px -5px 15px rgba(15, 23, 42, 0.5),
                            0 4px 12px rgba(0, 0, 0, 0.2);
                        animation: loader-pulse 2s ease-in-out infinite;
                    }

                    @keyframes loader-pulse {

                        0%,
                        100% {
                            transform: scale(1);
                            opacity: 0.85;
                        }

                        50% {
                            transform: scale(1.04);
                            opacity: 1;
                        }
                    }
                </style>
                <div class="loader-orb"></div>
            </div>
        </div>
    </div>

    <div class="app-layout" style="visibility: hidden;">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-area">
                    <span class="logo-text">Veridat</span>
                </div>
                <button id="sidebar-toggle" class="sidebar-toggle" aria-label="Toggle sidebar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <line x1="5" y1="7" x2="19" y2="7"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                        <line x1="5" y1="17" x2="19" y2="17"></line>
                    </svg>
                </button>
            </div>

            <div class="sidebar-action">
                <button id="new-chat-btn" class="new-chat-btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Ny konversation
                </button>
            </div>

            <div class="sidebar-nav">
                <div class="nav-section">
                    <div id="conversation-list-container">
                        <!-- ConversationList mounted here -->
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <button id="search-btn" class="nav-item" title="S√∂k konversationer (‚åòK)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <span>S√∂k</span>
                    <kbd class="nav-item-shortcut">‚åòK</kbd>
                </button>
                <button id="integrations-btn" class="nav-item">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                    <span>Integreringar</span>
                </button>
                <button id="agent-dashboard-btn" class="nav-item">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2l7 4v6c0 5-3.5 9-7 10-3.5-1-7-5-7-10V6l7-4z"></path>
                    </svg>
                    <span>Bokf√∂ringsstatus</span>
                </button>
                <button id="contact-btn" class="nav-item">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                    <span>Kontakta oss</span>
                </button>
                <button id="settings-btn" class="nav-item">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span>Inst√§llningar</span>
                </button>
                <button id="theme-toggle" class="nav-item">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <span>Tema</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <div class="actions">
                    <div class="company-selector">
                        <div class="company-select">
                            <select id="company-select" class="company-dropdown"></select>
                            <svg class="company-chevron" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></path>
                            </svg>
                        </div>
                        <button id="edit-company-btn" class="edit-company-btn" title="Redigera f√∂retag">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="memory-indicator-root"></div>
                    <button id="grid-toggle-btn" class="fortnox-toggle-btn grid-toggle-btn" title="Visa rutn√§t" aria-pressed="false">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7" rx="1"/>
                            <rect x="14" y="3" width="7" height="7" rx="1"/>
                            <rect x="3" y="14" width="7" height="7" rx="1"/>
                            <rect x="14" y="14" width="7" height="7" rx="1"/>
                        </svg>
                        <span>Grid</span>
                    </button>
                    <button id="fortnox-sidebar-toggle" class="fortnox-toggle-btn" title="Fortnox panel">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <path d="M15 3v18"/>
                        </svg>
                        <span>FX</span>
                    </button>
                </div>
            </header>

            <div class="workspace-split">
                <!-- Chat Area -->
                <div class="chat-wrapper chat-section">
                    <!-- Welcome Hero -->
                    <div class="welcome-hero">
                    <div class="hero-avatar veridat-spinner large">
                        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3" />
                            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
                        </svg>
                    </div>
                        <div id="welcome-header-mount">
                            <h1>Hej d√§r üëã</h1>
                            <p>Ber√§tta vad du beh√∂ver, s√• sk√∂ter vi resten.</p>
                        </div>

                        <!-- Suggestions Container - Populated by JS/CSS usually, but static structure here for now -->
                        <div class="welcome-suggestions">
                            <button class="suggestion-card primary" data-prompt="Analysera min Excel-fil">
                                <div class="card-icon">üìä</div>
                                <div class="card-content">
                                    <strong>Data Assistant</strong>
                                    <span>Designed to help manage sales...</span>
                                </div>
                            </button>
                            <div class="suggestion-grid">
                                <button class="suggestion-card secondary" data-prompt="Hur bokf√∂r jag representation?">
                                    <span>üìÑ Bokf√∂ra representation</span>
                                </button>
                                <button class="suggestion-card secondary"
                                    data-prompt="Vilken moms g√§ller f√∂r tj√§nster?">
                                    <span>‚öñÔ∏è Momsregler</span>
                                </button>
                                <button class="suggestion-card secondary" data-prompt="Hur g√∂r jag ett bokslut?">
                                    <span>‚úÖ Bokslut</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="chat-view" class="view active">
                        <div class="chat-container" id="chat-container"></div>
                    </div>

                    <!-- Floating Input -->
                    <div class="floating-input-container">
                        <form id="chat-form" class="floating-form chat-input-wrapper">
                            <!-- Model Selector -->
                            <div class="model-selector-container">
                                <button type="button" id="model-selector-btn" class="model-selector-btn" title="V√§lj AI-modell">
                                    <svg class="model-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="3"/>
                                        <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/>
                                    </svg>
                                    <span class="model-name" id="current-model-name">Flash</span>
                                    <svg class="chevron-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M6 9l6 6 6-6"/>
                                    </svg>
                                </button>
                                <div id="model-dropdown" class="model-dropdown hidden">
                                    <button type="button" class="model-option active" data-model="flash">
                                        <div class="model-option-content">
                                            <span class="model-option-icon">‚ö°</span>
                                            <div class="model-option-text">
                                                <span class="model-option-name">Gemini 3 Flash</span>
                                                <span class="model-option-desc">Snabb & effektiv</span>
                                            </div>
                                        </div>
                                        <svg class="check-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                            <polyline points="20 6 9 17 4 12"/>
                                        </svg>
                                    </button>
                                    <button type="button" class="model-option" data-model="pro">
                                        <div class="model-option-content">
                                            <span class="model-option-icon">‚ú®</span>
                                            <div class="model-option-text">
                                                <span class="model-option-name">Gemini 3 Pro</span>
                                                <span class="model-option-desc">Djupare analys</span>
                                            </div>
                                        </div>
                                        <span class="pro-badge">PRO</span>
                                    </button>
                                </div>
                            </div>

                            <!-- File Preview inside/above -->
                            <div id="file-preview" class="file-preview hidden">
                                <span class="file-name">file.pdf</span>
                                <button type="button" class="remove-file">√ó</button>
                            </div>

                            <div class="text-input-container">
                                <!-- Combined Attach Button (formerly menu-btn) -->
                                <input type="file" id="file-input" hidden>
                                <button type="button" id="attach-btn" class="input-action-btn" title="Bifoga">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <circle cx="12" cy="12" r="10" />
                                        <path d="M12 8v8M8 12h8" />
                                    </svg>
                                </button>

                                <div class="user-input-relative" style="flex: 1; position: relative; display: flex; align-items: center; min-width: 0;">
                                    <div id="animated-placeholder-container" class="animated-placeholder-container"></div>
                                    <input type="text" id="user-input" placeholder=""
                                        autocomplete="off">
                                </div>

                                <div id="voice-recording-ui" class="voice-recording-ui hidden">
                                    <div class="waveform-container">
                                        <div class="waveform-bar"></div>
                                        <div class="waveform-bar"></div>
                                        <div class="waveform-bar"></div>
                                        <div class="waveform-bar"></div>
                                        <div class="waveform-bar"></div>
                                        <div class="waveform-bar"></div>
                                        <div class="waveform-bar"></div>
                                        <div class="waveform-bar"></div>
                                    </div>
                                    <button type="button" id="voice-cancel-btn" class="voice-action-btn cancel-btn"
                                        title="Avbryt">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                    <button type="button" id="voice-confirm-btn" class="voice-action-btn confirm-btn"
                                        title="Bekr√§fta">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    </button>
                                </div>

                                <button type="button" id="mic-btn" class="input-action-btn">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                                        <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                                        <line x1="12" y1="19" x2="12" y2="23" />
                                        <line x1="8" y1="23" x2="16" y2="23" />
                                    </svg>
                                    <span class="btn-label">R√∂st</span>
                                </button>

                                <button type="submit" id="send-btn" class="send-btn-round">
                                    <span>Skicka</span>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <line x1="22" y1="2" x2="11" y2="13" />
                                        <polygon points="22 2 15 22 11 13 2 9 22 2" />
                                    </svg>
                                </button>

                            </div>
                        </form>
                    </div>
                </div>

                <!-- Fortnox Sidebar Panel -->
                <div id="fortnox-sidebar"></div>

                <!-- Excel Panel Backdrop (Mobile) -->
                <div id="excel-panel-backdrop" class="excel-panel-backdrop"></div>

                <!-- Excel/Artifact Panel (Split View) -->
                <div id="excel-panel" class="excel-panel">
                    <div class="excel-header">
                        <div class="excel-title">
                            <div class="excel-title-icon" id="excel-title-icon">üìä</div>
                            <span id="excel-filename">Sheet.xlsx</span>
                        </div>
                        <div id="excel-header-actions" class="excel-header-actions"></div>
                        <button id="close-excel-panel" class="close-excel-btn" title="St√§ng panel">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 6L6 18M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    <!-- Tab bar for VAT report navigation -->
                    <div id="panel-tabs" class="panel-tabs hidden">
                        <button class="panel-tab active" data-tab="summary">Sammanfattning</button>
                        <button class="panel-tab" data-tab="transactions">Transaktioner</button>
                        <button class="panel-tab" data-tab="journal">Bokf√∂ring</button>
                    </div>
                    <div id="sheet-tabs" class="sheet-tabs"></div>
                    <div id="excel-table-container" class="excel-table-container"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals (Settings, Company, Legal, Integrations, Search) -->
    <div id="settings-modal-container"></div>
    <div id="integrations-modal-container"></div>
    <div id="agent-dashboard-modal-container"></div>
    <div id="legal-modal-container"></div>
    <div id="search-modal-container"></div>
    <div id="company-modal" class="modal hidden">
        <!-- Content preserved from original ... -->
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">L√§gg till nytt bolag</h2>
                <button id="close-modal-btn" class="close-btn">&times;</button>
            </div>
            <form id="company-form">
                <input type="hidden" id="company-id" value="">
                <div class="form-group">
                    <label for="company-name">F√∂retagsnamn *</label>
                    <input type="text" id="company-name" required placeholder="Mitt F√∂retag AB">
                </div>
                <div class="form-group">
                    <label for="org-number">Organisationsnummer</label>
                    <input type="text" id="org-number" placeholder="556XXX-XXXX">
                </div>
                <!-- ... other fields ... -->
                <div class="modal-footer">
                    <button type="button" id="delete-company-btn" class="danger-btn hidden">Ta bort f√∂retag</button>
                    <div class="modal-footer-right">
                        <button type="button" id="cancel-modal-btn" class="secondary-btn">Avbryt</button>
                        <button type="submit" id="submit-btn" class="primary-btn">Skapa bolag</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Company Delete Confirmation Modal -->
    <div id="confirm-delete-company" class="confirm-modal-overlay hidden">
        <div class="confirm-modal">
            <h3 class="confirm-modal-title">Ta bort f√∂retag?</h3>
            <p class="confirm-modal-body">
                √Ñr du s√§ker p√• att du vill ta bort <strong id="delete-company-name"></strong>?
                Detta kan inte √•ngras.
            </p>
            <div class="confirm-modal-actions">
                <button id="cancel-delete-company" class="confirm-modal-btn">Avbryt</button>
                <button id="confirm-delete-company-btn" class="confirm-modal-btn-danger">Ta bort</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="/src/main.ts"></script>
    
    <!-- Vercel Speed Insights -->
    <script>
        window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/speed-insights/script.js"></script>
</body>

</html>
