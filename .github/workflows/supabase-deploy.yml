name: Supabase Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Deploy Supabase migrations and functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          set -euo pipefail

          if [ -z "${SUPABASE_ACCESS_TOKEN:-}" ]; then
            echo "Missing SUPABASE_ACCESS_TOKEN" >&2
            exit 1
          fi
          if [ -z "${SUPABASE_DB_PASSWORD:-}" ]; then
            echo "Missing SUPABASE_DB_PASSWORD" >&2
            exit 1
          fi
          if [ -z "${SUPABASE_PROJECT_REF:-}" ]; then
            echo "Missing SUPABASE_PROJECT_REF" >&2
            exit 1
          fi

          ./node_modules/.bin/supabase link --project-ref "$SUPABASE_PROJECT_REF" --password "$SUPABASE_DB_PASSWORD" --yes
          ./node_modules/.bin/supabase db push --include-all --yes

          FUNCTIONS=$(find supabase/functions -maxdepth 2 -type f -name index.ts -print | xargs -n1 dirname | xargs -n1 basename | sort -u | tr '\n' ' ')
          echo "Deploying functions: $FUNCTIONS"
          ./node_modules/.bin/supabase functions deploy $FUNCTIONS --project-ref "$SUPABASE_PROJECT_REF" --use-api --yes
